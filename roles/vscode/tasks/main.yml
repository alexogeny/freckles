- name: is microsoft signing key present | stat
  stat:
    path: "/etc/apt/trusted.gpg.d/packages.microsoft.gpg"
  register: has_microsoft_signing_key

- name: install microsoft signing key | shell
  become: true
  become_user: root
  shell: |
    wget -qO- https://packages.microsoft.com/keys/microsoft.asc |
    gpg --dearmor > /tmp/packages.microsoft.gpg
    install -o root -g root -m 644 /tmp/packages.microsoft.gpg /etc/apt/trusted.gpg.d/
    rm -f /tmp/packages.microsoft.gpg
  when: not has_microsoft_signing_key.stat.exists

- name: vscode repo | apt
  become: true
  become_user: root
  apt_repository:
    repo: deb [arch=amd64,arm64,armhf signed-by="/etc/apt/trusted.gpg.d/packages.microsoft.gpg"] https://packages.microsoft.com/repos/code stable main
    state: present
    filename: vscode

- name: install vscode | apt
  become: true
  become_user: root
  apt:
    name: code
    state: latest

- name: install vscode extensions | code
  shell: code --install-extension {{ item }}
  loop: "{{vscode_extensions}}"
  register: extension_results
  failed_when: extension_results.rc != 0
  changed_when: '"successfully" in extension_results.stdout'

- name: link vscode settings | file
  file:
    src: "{{playbook_dir}}/roles/vscode/files/settings.link.json"
    dest: "/home/{{u}}/.config/Code/User/settings.json"
    state: link
    force: true

- name: link vscode keybindings | file
  file:
    src: "{{playbook_dir}}/roles/vscode/files/keybinds.link.json"
    dest: "/home/{{u}}/.config/Code/User/keybindings.json"
    state: link
    force: true
